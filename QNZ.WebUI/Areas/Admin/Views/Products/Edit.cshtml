@model QNZ.Model.ViewModel.ProductIM
@{
    ViewData["Title"] = "编辑商品";
}

<h4>@ViewData["Title"]</h4>
<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Edit" data-ajax-begin="onBeginSave" data-ajax-complete="onCompleteSave"
              data-ajax-failure="onFailed" data-ajax-success="onSuccessSave"
              data-ajax="true" data-ajax-method="POST">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input asp-for="Thumbnail" class="form-control" type="hidden" />

            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="SubName" class="control-label"></label>
                <input asp-for="SubName" class="form-control" />
                <span asp-validation-for="SubName" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="CategoryIds" class="control-label"></label>
                <select asp-for="CategoryIds" class="form-control" multiple asp-items="@ViewBag.Categories">
                    <option>--请选择产品分类--</option>
                </select>
                <span asp-validation-for="CategoryIds" class="text-danger"></span>
            </div>
            @*@{
                        var categories = (SelectList)ViewBag.Categories;
                        int i = 0;
                        foreach (var item in categories)
                        {
        <div class="form-check form-check-inline">
            @if (item.Value == null)
                    {
                        return;
                    }


                    @if (Model.CategoryIds != null && Model.CategoryIds.Contains(int.Parse(item.Value)))
            {
                <input class="form-check-input" name="CategoryIds" checked type="checkbox">
            }
            else
            {
                <input class="form-check-input" name="CategoryIds" id="CategoryIds@i" type="checkbox">
            }

            <label class="form-check-label" for="inlineCheckbox1">@item.Text</label>
        </div>
                i++;
            }
        }*@


            <div class="form-group">
                <label asp-for="StoreId" class="control-label"></label>
                <select asp-for="StoreId" class="form-control" asp-items="@ViewBag.Stores">
                    <option>--请选择店铺/基地--</option>
                </select>
                <span asp-validation-for="StoreId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Specification" class="control-label"></label>
                <input asp-for="Specification" class="form-control" />
                <span asp-validation-for="Specification" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Price" class="control-label"></label>
                <input asp-for="Price" class="form-control" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="OriginalPrice" class="control-label"></label>
                <input asp-for="OriginalPrice" class="form-control" />
                <span asp-validation-for="OriginalPrice" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Unit" class="control-label"></label>
                <input asp-for="Unit" class="form-control" />
                <span asp-validation-for="Unit" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Stock" class="control-label"></label>
                <input asp-for="Stock" class="form-control" />
                <span asp-validation-for="Stock" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Description" class="control-label"></label>
                @*<input asp-for="Description" type="hidden" />*@
                <script id="Description" name="Description" style="height:20rem;width:100%;" type="text/plain">
                    @Html.Raw(Model.Description)
                </script>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Summary" class="control-label"></label>
                <textarea asp-for="Summary" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Summary" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FullImages" class="control-label"></label>
                <div class="col-md-10">
                    <div id="imagePicker">选择图片</div>
                    <input asp-for="FullImages" type="hidden" />
                    <span class="help-block">
                        @string.Format("图像大小：{0}x{1} 像素", SIG.Infrastructure.Configs.SettingsManager.Product.ImageWidth, SIG.Infrastructure.Configs.SettingsManager.Product.ImageHeight)
                    </span>
                    <span asp-validation-for="FullImages" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group">
                <div id="uploader-demo" class="clearfix">
                    <!--用来存放item-->
                    <div id="imageList" class="uploader-list">
                        @{
                            if (!string.IsNullOrEmpty(Model.FullImages))
                            {
                                var images = Model.FullImages.Split('|');
                                foreach (var item in images)
                                {
                                    <div class="file-item thumbnail pull-left  mr-2 mb-2 upload-state-done">
                                        <img src="@string.Format("{0}?width=120&height=90&mode=crop", item)" style="height:5rem;">
                                        <div class="info">
                                            <button type="button" data-img="@item" class="btn btn-danger btn-sm btnRemove">删除</button>
                                        </div>
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox">
                    <label>
                        <input asp-for="Active" /> @Html.DisplayNameFor(model => model.Active)
                    </label>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> 保存</button>
                <a asp-action="Index" class="btn btn-outline-secondary">返回</a>
            </div>
        </form>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-header text-center">
                缩略图设置
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">

                    @if (string.IsNullOrEmpty(Model.Thumbnail))
                    {
                        <div class="thumb" id="divThumb">
                            <i class="fa fa-picture-o fa-3x"></i>
                        </div>

                    }
                    else
                    {
                        <div class="thumb" id="divThumb" style="background-image:url(@Model.Thumbnail)">
                        </div>

                    }
                    <input type="file" id="files" hidden name="files" class="thumbFile" />

                    <input type="button" class="btn btn-outline-primary btn-block mb-1"
                           id="upload"
                           value="上传照片" />

                </form>
                <p class="text-center">*图片尽寸：250*250像素</p>
            </div>
        </div>
    </div>
</div>


@section header{
    <link href="~/plugins/webuploader/webuploader.min.css" rel="stylesheet" />
    <link href="~/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <style>
        .thumb {
            height: 160px;
            margin: 0 auto 1rem;
            padding-top: 3.5rem;
            cursor: pointer;
            background-color: #ddd;
            text-align: center;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center center;
        }
    </style>

}

@section footer {

    <script src="~/js/lib/jquery/plugins/jquery.validate.min.js"></script>
    <script src="~/js/lib/jquery/plugins/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/js/lib/jquery/plugins/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/plugins/neditor/utf8-net/neditor.config.js"></script>
    <script src="~/plugins/neditor/utf8-net/neditor.all.min.js"></script>
    <script src="~/plugins/webuploader/webuploader.min.js"></script>

    <script src="~/plugins/select2/js/i18n/zh-CN.js"></script>
    <script src="~/plugins/select2/js/select2.min.js"></script>

    <script>

        var ue = UE.getEditor('Description', {
            autoHeight: false,
            autoHeightEnabled: false,
            autoFloatEnabled: false
        });


        var $list = $("#imageList");
        // 初始化Web Uploader
        var uploader = WebUploader.create({
            // 选完文件后，是否自动上传。
            auto: true,
            // swf文件路径
            swf:  '/plugins/webuploader/js/Uploader.swf',
            // 文件接收服务端。
            server: "@Url.Action("UpLoadImages")",

            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: '#imagePicker',

            // 只允许选择图片文件。
            accept: {
                title: 'Images',
                extensions: 'gif,jpg,jpeg,bmp,png',
                mimeTypes: 'image/*'
            }
        });

        // 当有文件添加进来的时候
        uploader.on('fileQueued', function (file, result) {
            var $li = $(
                '<div id="' + file.id + '" class="file-item thumbnail pull-left  mr-2 mb-2">' +
                '<img style="height:100px;">' +
                '<div class="info"><button type="button" data-img="" class="btn btn-danger btn-sm btnRemove">删除</button></div>' +
                '</div>'
            ),
                $img = $li.find('img');


            // $list为容器jQuery实例
            $list.append($li);


        });

        // 文件上传过程中创建进度条实时显示。
        uploader.on('uploadProgress', function (file, percentage) {
            var $li = $('#' + file.id),
                $percent = $li.find('.progress span');

            // 避免重复创建
            if (!$percent.length) {
                $percent = $('<p class="progress"><span></span></p>')
                    .appendTo($li)
                    .find('span');
            }

            $percent.css('width', percentage * 100 + '%');
        });

        // 文件上传成功，给item添加成功class, 用样式标记上传成功。
        uploader.on('uploadSuccess', function (file, result) {
            $('#' + file.id).addClass('upload-state-done');
            $('#' + file.id + ' img').attr("src", result.fileName + "?width=120&height=90&mode=crop");
            $('#' + file.id + ' button').attr("data-img", result.fileName);

            var img = $("#FullImages").val();
          //  console.log(img);
            if (img.length === 0) {
                $("#FullImages").val(result.fileName);
            } else {
                img = img + "|" + result.fileName;
                $("#FullImages").val(img);
            }
            //console.log(result);
        });

        // 文件上传失败，显示上传出错。
        uploader.on('uploadError', function (file) {
            var $li = $('#' + file.id),
                $error = $li.find('div.error');

            // 避免重复创建
            if (!$error.length) {
                $error = $('<div class="error"></div>').appendTo($li);
            }

            $error.text('上传失败');
        });

        // 完成上传完了，成功或者失败，先删除进度条。
        uploader.on('uploadComplete', function (file) {
            $('#' + file.id).find('.progress').remove();
        });





        function onFailed() {
            toastr.error("操作失败！");
        }

        function onBeginSave() {
            $("#btnSave i").removeClass("fa-save").addClass("fa-spinner fa-spin");
        }
        function onCompleteSave() {
            $("#btnSave i").removeClass("fa-spinner fa-spin").addClass("fa-save");
        }


        function onSuccessSave(data) {
            if (data.status === 1) {
                var url = "@Url.Action("Index")";
                toastr.success(data.message);
                location.href = url;

            }
            if (data.status === 2) {
                toastr.error(data.message);
            }
            //Common.ShowBoxWithFuncBack(data, title, submitSuccess);

        }



        $(function () {

            $("#CategoryIds").select2();
             //移除图片
           $(document).on("click", '.btnRemove', function (e) {
                e.preventDefault();
                var item = $(this).closest(".file-item");
                var imgName = $(this).attr('data-img');
                var url = "@Url.Action("RemoveImage")";

                $.post(url, { img: imgName }, function (data) {

                    if (data.status === 1) {
                        item.remove();

                        var images = $("#FullImages").val();
                        var ar = images.split("|");
                        var i = ar.indexOf(imgName);
                        if (i != -1) {
                            ar.splice(i, 1);
                        }
                        $("#FullImages").val(ar.join("|"));
                    }
                    if (data.status === 2) {
                        toastr.error(data.Message)
                    }
                });

            });



            $("#divThumb").click(function () {
                $('input.thumbFile').click();
            })
            $('input.thumbFile').change(function () {
                readURL(this);
            });
            function readURL(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                       // $('#blah').attr('src', e.target.result);
                        $("#divThumb").css({ "background-image": "url(" + e.target.result + ")" });
                        $("#divThumb i").remove();
                    }

                    reader.readAsDataURL(input.files[0]);
                }
            }



            $("#upload").click(function (evt) {
                var fileUpload = $("#files").get(0);
                var files = fileUpload.files;
                var data = new FormData();
                for (var i = 0; i < files.length; i++) {
                    data.append(files[i].name, files[i]);
                }
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("UploadAsync")",
                    contentType: false,
                    processData: false,
                    data: data,
                    success: function (message) {
                        //alert(message);
                        $("#Thumbnail").val(message);
                        toastr.success("照片已上传到服务器。");
                    },
                    error: function () {
                        //alert("There was error uploading files!");
                        toastr.error("上传文件失败");
                    }
                });
            });




        });
    </script>
}