function closeUploader(){$("#thelist").html("");$("#picker").text("选择文件");$("#uploadFile").removeClass("show").animate({top:"-100px"},600)}var SIG=function(){function t(n){$.getJSON(n,function(n){var t="";$.each(n,function(n,i){var r=i.HasChildren?"":"hidden";t+='<li><div class="exp"><a href="#" class="btnDir" data-loaded="0" data-path="'+i.DirPath.toLowerCase()+'" '+r+'><span class="fa fa-plus fa-fw"><\/span><\/a><\/div><a href="#" class="btnFile" data-path="'+i.DirPath.toLowerCase()+'"><span class="fa fa-folder fa-fw"><\/span>'+i.Name+"<\/a><\/li>"});$("#dirTree").html(t)})}function r(n,t){t.find("ul").remove();$.getJSON(n,function(n){var i="";$.each(n,function(n,t){var r=t.HasChildren?"":"hidden";i+='<li><div class="exp"><a href="#" class="btnDir" data-loaded="0" data-path="'+t.DirPath.toLowerCase()+'" '+r+'><span class="fa fa-plus fa-fw"><\/span><\/a><\/div><a href="#" class="btnFile" data-path="'+t.DirPath.toLowerCase()+'"><span class="fa fa-folder fa-fw"><\/span>'+t.Name+"<\/a><\/li>"});$("<ul/>",{html:i}).addClass("subTree").appendTo(t);t.children(".exp").find("a").attr("data-loaded","1").find("span").removeClass("fa-plus").addClass("fa-minus")})}function i(n){$.getJSON(n,function(n){u(n)})}function u(n){$("#fileList").empty();$.each(n,function(n,t){var i='<div class="col-sm-3 itembox"><div class="card card-default item" data-file="'+t.FilePath+'" data-name="'+t.Name+'"><div class="card-body filebox text-center"><img src="'+t.ImgUrl+'" class="img-responsive" /><\/div><div class="card-footer"><div class="boxfooter"><span>'+t.Name+"<\/span><br/><small>"+t.CreatedDate+'<\/small><br /> <div><div class="btn-group btn-group-sm pull-right" role="group"><button type="button" class="btn btn-outline-secondary rename" title="重命名"><span class="fa fa-pencil"><\/span><\/button><button type="button" class="btn btn-outline-secondary download" title="下载"><span class="fa fa-download"><\/span><\/button><button type="button" class="btn btn-outline-secondary btnDelete" title="删除"><span class="fa fa-trash"><\/span><\/button><\/div>'+t.FileSize+"KB<\/div><\/div><\/div><\/div><\/div>";$(i).appendTo($("#fileList"))})}function f(n){var u,i,o,r;if(n=n.toLowerCase(),u="/Uploads/",n.startsWith(u.toLowerCase())){var e=n.split("/"),s=n.indexOf(e[e.length-1])-1,h=n.substring(9,s),f=h.split("/"),t=u;for(i=0;i<f.length;i++)t=t+f[i],t=t.toLowerCase(),o=$("a[data-path='"+t+"']").eq(0).closest("li"),i<f.length-1?(r="/api/filemanager/GetSubDirectories?dir="+t,SIG.getInstance().getSubDirectories(r,o),t=t+"/"):(r="/api/filemanager/GetSubFiles?dir="+t,SIG.getInstance().getFiles(r),$("#btnRefresh").attr("data-dir",t),setTimeout(function(){$("[data-path='"+t+"']").eq(1).addClass("active").children("span").removeClass("fa-folder").addClass("fa-folder-open");$("#fileList div[data-file='"+n+"']").addClass("active")},1e3))}}function e(n,t,i){$.ajax({type:"POST",contentType:"application/json",url:"/api/filemanager/RenameFile?filePath="+n+"&newFilePath="+t,dataType:"json",success:function(n){n==="OK"?(toastr.success("已重名文件","重命名"),i.attr("data-file",t),i.find(".boxfooter").children("span").text(t.split("/").pop())):n==="NO"?toastr.warning("此文件名已经存在！","重命名"):toastr.error(n,"重命名")}})}function o(){var n;t("/api/filemanager/RootDirectories");n="/api/filemanager/RootDirFiles";i(n);$("#btnRefresh").attr("data-dir",$("#rootDir").val())}function s(){alert("aaaaa")}function h(){return{Initialize:o,getFiles:i,getSubDirectories:r,getDirectories:t,renameFile:e,loadCurrentURL:f,test:s}}var n;return{getInstance:function(){return n||(n=h())}}}(),SIGFinder;(function(){"use strict";function l(n,t){var i=n.srcElement||n.target;if(i.classList.contains(t))return i;while(i=i.parentNode)if(i.classList&&i.classList.contains(t))return i;return!1}function v(n){var t=0,i=0,n;return n||(n=window.event),n.pageX||n.pageY?(t=n.pageX,i=n.pageY):(n.clientX||n.clientY)&&(t=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=n.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t,y:i}}function w(){b();k();d();g()}function b(){document.addEventListener("contextmenu",function(n){t=l(n,p);t?(n.preventDefault(),nt(),tt(n)):(t=null,i())})}function k(){document.addEventListener("click",function(n){var t=l(n,y),r;t?(n.preventDefault(),it(t)):(r=n.which||n.button,r===1&&i())})}function d(){window.onkeyup=function(n){n.keyCode===27&&i()}}function g(){window.onresize=function(){i()}}function nt(){r!==1&&(r=1,n.classList.add(a))}function i(){r!==0&&(r=0,n.classList.remove(a))}function tt(t){u=v(t);f=u.x;e=u.y;o=n.offsetWidth+4;s=n.offsetHeight+4;h=window.innerWidth;c=window.innerHeight;var i=$("#dirbody").offset();n.style.left=h-f<o?h-o-i.left+"px":f-i.left+"px";n.style.top=c-e<s?c-s-i.top+"px":e-i.top+"px"}function it(n){var r=t.getAttribute("data-path"),s=n.getAttribute("data-action"),f,u,e,o;switch(s){case"create":u=prompt("创建子目录","");u.length>0&&$.ajax({type:"POST",contentType:"application/json",url:"/api/filemanager/CreateDir?filePath="+r+"&dir="+u,dataType:"json",success:function(n){if(n==="OK"){var i=t.closest("li"),u="/api/filemanager/GetSubDirectories?dir="+r;SIG.getInstance().getSubDirectories(u,$(i))}else n==="NO"?toastr.warning("此目录已存在！","创建目录"):toastr.error(n,"创建目录")}});break;case"delete":$.ajax({type:"POST",contentType:"application/json",url:"/api/filemanager/DeleteDir?filePath="+r,dataType:"json",success:function(n){if(n==="OK"){var i=t.closest("li"),r=$(i).closest("ul").closest("li"),u=$(i).closest("ul").prevAll("a:first").attr("data-path"),f="/api/filemanager/GetSubDirectories?dir="+u;SIG.getInstance().getSubDirectories(f,r)}else n==="NO"?toastr.warning("此目录还有文件存在！","删除目录"):toastr.error(n,"删除目录")}});break;case"rename":f=r.split("/").pop();u=prompt("重命名",f);u!=null&&(e=r.length-f.length,o=r.substr(0,e)+u,$.ajax({type:"POST",contentType:"application/json",url:"/api/filemanager/RenameDir?filePath="+r+"&newFilePath="+o,dataType:"json",success:function(n){if(n==="OK"){var i=t.closest("li"),r=$(i).closest("ul").closest("li"),u=$(i).closest("ul").prevAll("a:first").attr("data-path"),f="/api/filemanager/GetSubDirectories?dir="+u;SIG.getInstance().getSubDirectories(f,r)}else n==="NO"?toastr.warning("此目录名已经存在！","重命名目录"):toastr.error(n,"重命名目录")}}))}i()}var y="context-menu__link",a="context-menu--active",p="btnFile",t,u,f,e,n=document.querySelector("#context-menu"),rt=n.querySelectorAll(".context-menu__item"),r=0,o,s,h,c;w()})();$(function(){$("#btnUpload").on("click",function(){if(!$("#uploadFile").hasClass("show")){$("#uploadFile").animate({top:"50px"},600).addClass("show");var t=$("#dirTree a.active").attr("data-path"),r=t!==undefined?t:"",u=$("#thelist"),f=$("#ctlBtn"),i="pending",n=WebUploader.create({resize:!1,auto:!0,swf:"http://localhost/plugins/webuploader/Uploader.swf",server:"/bbi-admin/file/UpLoadProcess",formData:{path:r},pick:"#picker",compress:null});n.on("fileQueued",function(n){u.append('<div id="'+n.id+'" class="item"><h4 class="info">'+n.name+'<\/h4><p class="state">等待上传...<\/p><\/div>')});n.on("uploadProgress",function(n,t){var i=$("#"+n.id),r=i.find(".progress .progress-bar");r.length||(r=$('<div class="progress progress-striped active"><div class="progress-bar" role="progressbar" style="width: 0%"><\/div><\/div>').appendTo(i).find(".progress-bar"));i.find("p.state").text("上传中");r.css("width",t*100+"%")});n.on("uploadSuccess",function(n){if($("#"+n.id).find("p.state").text("已上传"),closeUploader(),t!==undefined){var i="/api/filemanager/GetSubFiles?dir="+t;SIG.getInstance().getFiles(i)}else SIG.getInstance().Initialize()});n.on("uploadError",function(n){$("#"+n.id).find("p.state").text("上传出错")});n.on("uploadComplete",function(n){$("#"+n.id).find(".progress").fadeOut()});n.on("all",function(n){n==="startUpload"?i="uploading":n==="stopUpload"?i="paused":n==="uploadFinished"&&(i="done")})}});$("#btnClose").on("click",function(){closeUploader()});SIG.getInstance().Initialize();$("body").delegate("#btnRoot","click",function(n){n.preventDefault();SIG.getInstance().Initialize()});$("body").delegate("a.btnDir","click",function(n){var t,i,r,u;n.preventDefault();t=$(this).attr("data-path");i=$(this).attr("data-loaded");i==="0"?(r=$(this).closest("li"),u="/api/filemanager/GetSubDirectories?dir="+t,SIG.getInstance().getSubDirectories(u,r)):($(this).closest("li").find("ul").remove(),$(this).children("span").removeClass("fa-minus").addClass("fa-plus"),$(this).attr("data-loaded","0"))});$("body").delegate("a.btnFile","click",function(n){n.preventDefault();$("#dirTree a.active").removeClass("active").children("span").removeClass("fa-folder-open").addClass("fa-folder");$(this).addClass("active");var t=$(this).attr("data-path"),i="/api/filemanager/GetSubFiles?dir="+t;$(this).children("span").removeClass("fa-folder").addClass("fa-folder-open");SIG.getInstance().getFiles(i);$("#btnRefresh").attr("data-dir",t)});$("body").delegate("#btnRefresh","click",function(n){n.preventDefault();var t=$(this).attr("data-dir"),i="/api/filemanager/GetSubFiles?dir="+t;SIG.getInstance().getFiles(i)});$("body").delegate("div.item","click",function(n){n.preventDefault();$(this).hasClass("active")?$(this).removeClass("active"):($("#fileList .item.active").removeClass("active"),$(this).addClass("active"))});$("body").delegate(".rename","click",function(n){n.preventDefault();var i=$(this).closest(".item"),t=i.attr("data-file"),u=t.split("/").pop(),r=prompt("重命名",u);if(r!=null){var e=t.length-u.length,f=t.substr(0,e)+r,o=t.split(".").pop().toLowerCase(),s=r.split(".").pop().toLowerCase();o===s?SIG.getInstance().renameFile(t,f,i):confirm("改变文件后缀名，可能导致文件不可用，是否要修改？")&&SIG.getInstance().renameFile(t,f,i)}});$("body").delegate(".download","click",function(n){n.preventDefault();var t=$(this).closest(".item"),i=t.attr("data-file");location.href="/api/filemanager/Download?filePath="+i});$("body").delegate(".btnDelete","click",function(n){n.preventDefault();var t=$(this).closest(".item"),i=t.attr("data-file"),r=$(this).closest(".itembox");$.ajax({type:"POST",contentType:"application/json",url:"/api/filemanager/DeleteFile?filePath="+i,dataType:"json",success:function(n){n==="OK"?(r.remove(),toastr.success("已删除文件","删除文件")):toastr.error(n,"删除文件")}})})});SIGFinder={ImagesUploadHandler:function(n,t,i){var r,u,f;r=new XMLHttpRequest;r.withCredentials=!1;r.open("POST","/bbi-admin/File/TinymceUpload");r.onload=function(){var n;if(r.status!=200){i("HTTP Error: "+r.status);return}if(n=JSON.parse(r.responseText),!n||typeof n.location!="string"){i("Invalid JSON: "+r.responseText);return}t(n.location)};f="";jQuery(tinymce.activeEditor.dom.getRoot()).find("img").not(".loaded-before").each(function(){f=$(this).attr("alt");$(this).addClass("loaded-before")});u=new FormData;u.append("file",n.blob(),n.filename());u.append("description",f);r.send(u)},FilePickerCallback:function(n){tinyMCE.activeEditor.windowManager.openUrl({url:"/bbi-admin/File/FinderForTinyMCE5",title:"文件管理",width:960,height:700});window.addEventListener("message",function(t){var i=t.data;n(i.content)})}};