/*!
 * QNZFinder - file manager for web
 * Version 1.0.1 (2020-01-31)
 * http://heiniaozhi.cn
 *
 * Copyright 2012-2020, 黑鸟志
 * Licensed under a 3-clauses BSD license
 */
function closeUploader(){$("#thelist").html("");$("#picker").text("选择文件");$("#uploadFile").removeClass("show").animate({top:"-100px"},600)}function uploadFiles(n){for(var t=$("#dirTree a.active").attr("data-path"),f=t!==undefined?t:"",e=document.getElementById(n),u=e.files,i=new FormData,r=0;r!=u.length;r++)i.append("files",u[r]);i.append("filePath",f);$.ajax({url:"/Admin/QNZFinder/UploadFiles",data:i,processData:!1,contentType:!1,type:"POST",xhr:function(){var n=new window.XMLHttpRequest;return n.upload.addEventListener("progress",function(n){if(n.lengthComputable){var t=Math.round(n.loaded/n.total*100);console.log(t)}},!1),n},success:function(){if(closeUploader(),t!==undefined){var n="/admin/qnzfinder/GetSubFiles?dir="+t;SIG.getInstance().getFiles(n)}else SIG.getInstance().Initialize()}})}var SIG=function(){function t(n){$.getJSON(n,function(n){var r=localStorage.getItem("lastOpenPath"),t="";$.each(n,function(n,u){var e=u.hasChildren?"":"hidden",f=u.isOpen?"minus":"plus";t+='<li class="'+f+'">';t+='<div class="exp"><a href="#" class="btnDir" data-loaded="1" data-path="'+u.dirPath+'" '+e+">";t+='<span class="iconfont icon-'+f+' fa-fw"><\/span><\/a><\/div> ';t+=r==u.dirPath?'<a href="#" class="btnFile active" data-path="'+u.dirPath+'"><span class="iconfont icon-folder-open-fill fa-fw"><\/span>'+u.name+"<\/a>":'<a href="#" class="btnFile" data-path="'+u.dirPath+'"><span class="iconfont icon-folder-fill fa-fw"><\/span>'+u.name+"<\/a>";t+=i(u.children);t+="<\/li > "});$("#dirTree").html(t)})}function i(n){var r=localStorage.getItem("lastOpenPath"),t='<ul class="subTree">';return $.each(n,function(n,u){var f=u.hasChildren?"":"hidden",e=u.isOpen?"minus":"plus";t+='<li class="'+e+'">';t+='<div class="exp"><a href="#" class="btnDir" data-loaded="1" data-path="'+u.dirPath+'" '+f+'><span class="iconfont icon-plus fa-fw"><\/span><\/a><\/div>';t+=r==u.dirPath?'<a href="#" class="btnFile active" data-path="'+u.dirPath+'"><span class="iconfont icon-folder-open-fill"><\/span>'+u.name+"<\/a>":'<a href="#" class="btnFile" data-path="'+u.dirPath+'"><span class="iconfont icon-folder-fill"><\/span>'+u.name+"<\/a>";t+=i(u.children);t+="<\/li>"}),t+="<\/ul>"}function f(n,t){t.find("ul").remove();$.getJSON(n,function(n){var i="";$.each(n,function(n,t){var r=t.hasChildren?"":"hidden";i+='<li><div class="exp"><a href="#" class="btnDir" data-loaded="0" data-path="'+t.dirPath+'" '+r+'><span class="iconfont icon-plus fa-fw"><\/span><\/a><\/div><a href="#" class="btnFile" data-path="'+t.dirPath+'"><span class="iconfont icon-folder-fill"><\/span>'+t.name+"<\/a><\/li>"});$("<ul/>",{html:i}).addClass("subTree").appendTo(t);t.children(".exp").find("a").attr("data-loaded","1").find("span").removeClass("icon-plus").addClass("icon-minus")})}function r(n){$.getJSON(n,function(n){e(n)})}function e(n){$("#fileList").empty();$.each(n,function(n,t){var i='<div class="itembox"><div class="qnz-card item" data-file="'+t.filePath+'" data-name="'+t.name+'"><div class="qnz-card-body"><img src="'+t.imgUrl+'" class="img-responsive" /><\/div><div class="qnz-card-footer"><div class="filename"><span>'+t.name+'<\/span><\/div><div class="date">date: '+t.createdDate+'<\/div> <div class="buttons"><div class="qnz-btn-group" role="group"><button type="button" class="qnz-btn rename" title="重命名"><i class="iconfont icon-edit"><\/i><\/button><button type="button" class="qnz-btn download" title="下载"><i class="iconfont icon-download"><\/i><\/button><button type="button" class="qnz-btn btnDelete" title="删除"><i class="iconfont icon-delete"><\/i><\/button><\/div><div class="fileSize">'+t.fileSize+"KB<\/div><\/div><\/div><\/div>";$(i).appendTo($("#fileList"))})}function o(n){var u,i,o,r;if(n=n,u="/Uploads/",n.startsWith(u)){var e=n.split("/"),s=n.indexOf(e[e.length-1])-1,h=n.substring(9,s),f=h.split("/"),t=u;for(i=0;i<f.length;i++)t=t+f[i],t=t,o=$("a[data-path='"+t+"']").eq(0).closest("li"),i<f.length-1?(r="/admin/qnzfinder/GetSubDirectories?dir="+t,SIG.getInstance().getSubDirectories(r,o),t=t+"/"):(r="/admin/qnzfinder/GetSubFiles?dir="+t,SIG.getInstance().getFiles(r),$("#btnRefresh").attr("data-dir",t),setTimeout(function(){$("[data-path='"+t+"']").eq(1).addClass("active").children("span").removeClass("icon-folder-fill").addClass("icon-folder-open-fill");$("#fileList div[data-file='"+n+"']").addClass("active")},1e3))}}function s(n,t,i){$.ajax({type:"POST",contentType:"application/json",url:"/admin/qnzfinder/RenameFile?filePath="+n+"&newFilePath="+t,dataType:"json",success:function(n){n.status===1?(toastr.success(n.message),i.attr("data-file",t),i.find(".boxfooter").children("span").text(t.split("/").pop())):toastr.error(n.message)}})}function h(){var n=localStorage.getItem("lastOpenPath"),e=n!=null?"/admin/qnzfinder/currentdirectories?currentDir="+n:"/admin/qnzfinder/currentdirectories",i,f;t(e);i=n!=null?"/admin/qnzfinder/GetSubFiles?dir="+n:"/admin/qnzfinder/GetSubFiles";r(i);f=n==null?$("#rootDir").val():n;u(f)}function u(n){var i=document.getElementById("filePath"),t;i.innerText=n;t=document.getElementById("filePathForm");t.value=n}function c(){return{Initialize:h,getFiles:r,getSubDirectories:f,getDirectories:t,renameFile:s,loadCurrentURL:o,setCurrentFilePath:u}}var n;return{getInstance:function(){return n||(n=c())}}}(),btnDropUpload,btnClose,SIGFinder;(function(){"use strict";function l(n,t){var i=n.srcElement||n.target;if(i.classList.contains(t))return i;while(i=i.parentNode)if(i.classList&&i.classList.contains(t))return i;return!1}function v(n){var t=0,i=0,n;return n||(n=window.event),n.pageX||n.pageY?(t=n.pageX,i=n.pageY):(n.clientX||n.clientY)&&(t=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=n.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t,y:i}}function w(){b();k();d();g()}function b(){document.addEventListener("contextmenu",function(n){t=l(n,p);t?(n.preventDefault(),nt(),tt(n)):(t=null,i())})}function k(){document.addEventListener("click",function(n){var t=l(n,y),r;t?(n.preventDefault(),it(t)):(r=n.which||n.button,r===1&&i())})}function d(){window.onkeyup=function(n){n.keyCode===27&&i()}}function g(){window.onresize=function(){i()}}function nt(){r!==1&&(r=1,n.classList.add(a))}function i(){r!==0&&(r=0,n.classList.remove(a))}function tt(t){u=v(t);f=u.x;e=u.y;o=n.offsetWidth+4;s=n.offsetHeight+4;h=window.innerWidth;c=window.innerHeight;var i=$("#dirbody").offset();n.style.left=h-f<o?h-o-i.left+"px":f-i.left+"px";n.style.top=c-e<s?c-s-i.top+"px":e-i.top+"px"}function it(n){var r=t.getAttribute("data-path"),s=n.getAttribute("data-action"),f,u,e,o;switch(s){case"create":u=prompt("创建子目录","");u.length>0&&$.ajax({type:"POST",contentType:"application/json",url:"/admin/qnzfinder/CreateDir?filePath="+r+"&dir="+u,dataType:"json",success:function(n){if(n.status===1){toastr.success(n.message,"创建目录");var i=t.closest("li"),u="/admin/qnzfinder/GetSubDirectories?dir="+r;SIG.getInstance().getSubDirectories(u,$(i))}else toastr.error(n.message,"创建目录")}});break;case"delete":$.ajax({type:"POST",contentType:"application/json",url:"/admin/qnzfinder/DeleteDir?filePath="+r,dataType:"json",success:function(n){if(n.status===1){toastr.success(n.message,"删除目录");var i=t.closest("li"),r=$(i).closest("ul").closest("li"),u=$(i).closest("ul").prevAll("a:first").attr("data-path"),f="/admin/qnzfinder/GetSubDirectories?dir="+u;SIG.getInstance().getSubDirectories(f,r)}else toastr.error(n.message,"删除目录")}});break;case"rename":f=r.split("/").pop();u=prompt("重命名",f);u!=null&&(e=r.length-f.length,o=r.substr(0,e)+u,$.ajax({type:"POST",contentType:"application/json",url:"/admin/qnzfinder/RenameDir?filePath="+r+"&newFilePath="+o,dataType:"json",success:function(n){if(n.status===1){toastr.success(n.message,"重命名目录");var i=t.closest("li"),r=$(i).closest("ul").closest("li"),u=$(i).closest("ul").prevAll("a:first").attr("data-path"),f="/admin/qnzfinder/GetSubDirectories?dir="+u;SIG.getInstance().getSubDirectories(f,r)}else toastr.error(n.message,"重命名目录")}}))}i()}var y="context-menu__link",a="context-menu--active",p="btnFile",t,u,f,e,n=document.querySelector("#context-menu"),r=0,o,s,h,c;w()})();btnDropUpload=document.getElementById("btnDropUpload");btnDropUpload.addEventListener("click",function(){var n=document.getElementById("uploadbox");n.style.display="block"});btnClose=document.getElementById("btnClose");btnClose.addEventListener("click",function(){var n=document.getElementById("uploadbox");n.style.display="none"});$(function(){$("#btnUploadFiles").click(function(n){n.preventDefault();uploadFiles("FileInput")});$("#btnUpload").on("click",function(){$("#uploadFile").hasClass("show")||$("#uploadFile").animate({top:"50px"},600).addClass("show")});$("#btnClose").on("click",function(){closeUploader()});SIG.getInstance().Initialize();$("body").delegate("#btnRoot","click",function(n){n.preventDefault();localStorage.clear();SIG.getInstance().Initialize()});$("body").delegate("a.btnDir","click",function(n){var t,i,r,u;n.preventDefault();t=$(this).closest("li");t.toggleClass("plus");t.toggleClass("minus");$(this).children("span").removeClass("icon-minus").addClass("icon-plus");i=$(this).attr("data-path");r=$(this).attr("data-loaded");r==="0"&&(u="/admin/qnzfinder/GetSubDirectories?dir="+i,SIG.getInstance().getSubDirectories(u,t))});$("body").delegate("a.btnFile","click",function(n){n.preventDefault();$("#dirTree a.active").removeClass("active").children("span").removeClass("icon-folder-open-fill").addClass("icon-folder-fill");$(this).addClass("active");var t=$(this).attr("data-path"),i="/admin/qnzfinder/GetSubFiles?dir="+t;localStorage.setItem("lastOpenPath",t);$(this).children("span").removeClass("icon-folder-fill").addClass("icon-folder-open-fill");SIG.getInstance().getFiles(i);SIG.getInstance().setCurrentFilePath(t)});$("body").delegate("#btnRefresh","click",function(n){n.preventDefault();var t=document.getElementById("filePath"),i=t.innerText,r="/admin/qnzfinder/GetSubFiles?dir="+i;SIG.getInstance().getFiles(r)});$("body").delegate("div.item","click",function(n){n.preventDefault();$(this).hasClass("active")?$(this).removeClass("active"):($("#fileList .item.active").removeClass("active"),$(this).addClass("active"))});$("body").delegate(".rename","click",function(n){n.preventDefault();var i=$(this).closest(".item"),t=i.attr("data-file"),u=t.split("/").pop(),r=prompt("重命名",u);if(r!=null){var e=t.length-u.length,f=t.substr(0,e)+r,o=t.split(".").pop().toLowerCase(),s=r.split(".").pop().toLowerCase();o===s?SIG.getInstance().renameFile(t,f,i):confirm("改变文件后缀名，可能导致文件不可用，是否要修改？")&&SIG.getInstance().renameFile(t,f,i)}});$("body").delegate(".download","click",function(n){n.preventDefault();var t=$(this).closest(".item"),i=t.attr("data-file");location.href="/admin/qnzfinder/Download?filePath="+i});$("body").delegate(".btnDelete","click",function(n){n.preventDefault();var t=$(this).closest(".item"),i=t.attr("data-file"),r=$(this).closest(".itembox");$.ajax({type:"POST",contentType:"application/json",url:"/admin/qnzfinder/DeleteFile?filePath="+i,dataType:"json",success:function(n){console.log(n.status);n.status===1?(r.remove(),toastr.success(n.message)):toastr.error(n.message)}})})});SIGFinder={FilePickerCallback:function(n,t,i){return tinymce.activeEditor.windowManager.open({file:"/Admin/QNZFinder/FinderForTinyMce",title:"QNZFinder 1.0",width:900,height:450,resizable:"yes"},{oninsert:function(t,r){var u,f;u="/"+t.path;f=t.name+" ("+r.formatSize(t.size)+")";i.filetype=="file"&&n(u,{text:f,title:f});i.filetype=="image"&&n(u,{alt:f});i.filetype=="media"&&n(u)}}),!1}};